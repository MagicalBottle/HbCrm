
@{
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}


<!-- Css -->
@section Css{
    <link href="~/css/admin.css?v=1.0.0" rel="stylesheet" />
}
<!-- Css -->
<!-- Scripts -->
@section Scripts{
    <script src="~/lib/jquery-validation/jquery.validate.js"></script>
    <script src="~/lib/jquery-formvalidation/js/formvalidation.js"></script>
    <script type="text/javascript">
        var validator  = $("#form-add-menu").formvalidation({
            rules: {
                menuName: {
                    required: true
                },
                menuSystermName: {
                    required: true
                },
                firstParentId: {
                    required: true
                },
                secondParentId: {
                    required: true
                },
                menuIcon: {
                    required: true
                },
                menuSort: {
                    required: true
                },
                menuUrl: {
                    required: true
                }
            },
            messages: {
                userName: "请输入菜单名称",
                password: "请输入菜单系统名称",
                firstParentId: "请选择菜单级别",
                secondParentId: "请选择菜单级别",
                menuIcon: "请选择菜单图标",
                menuSort: "请输入菜单排序",
                menuUrl: "请输入菜单地址"
            },
            submitHandler: function (form) {
                var requestData = {};
                requestData.menuName = $("#menuName").val().trim();
                requestData.menuSystermName = $("#menuSystermName").val().trim();
                requestData.firstParentMenuId = $("#firstParentMenuId").val().trim();
                requestData.secondParentMenuId = $("#secondParentMenuId").val().trim();
                requestData.menuIcon = $("#menuIcon").val().trim();
                requestData.menuSort = $("#menuSort").val().trim();
                requestData.menuUrl = $("#menuUrl").val().trim();
                requestData.menuRemark = $("#menuRemark").val().trim();
                $.ajax({
                    type: "POST",
                    url: "@Url.Action("Add", "Menu", new { area = "Admin" })",
                    dataType: "json",
                    contentType: "application/json;charset=utf-8",
                    data: JSON.stringify(requestData),
                    error: function (request, message, error) {
                        alert(request);
                    },
                    success: function (responseData) {
                        data = JSON.parse(responseData);
                        if (data.Status == 1) {
                            var backToList = $("#btn-save").data("backToList");
                            if (backToList) {
                                window.location.href = "@Url.Action("Index", "Menu", new { area = "Admin" })";
                            } else {
                                //清空所有选项
                                $("#menuName").val('');
                                $("#menuSystermName").val('');
                                $("#firstParentMenuId").val(0);
                                $("#secondParentMenuId").val(0);
                                $("#menuIcon").val('');
                                $("#menuSort").val(0);
                                $("#menuUrl").val('');
                                $("#menuRemark").val('');
                            }
                        } else {
                            if (data.Code == "menu_exsit_menuSystermName") {
                                alert("菜单系统名称已存在");
                                $("#menuSystermName").focus();
                                return;
                            }
                            alert(data.Message)
                        }
                    }//success
                });//ajax
            }//submitHandler
        }); //validator
        $("#btn-save").click(function () {
            $(this).data("backToList",true);
            if (validator.form()) {
                $("#form-add-menu").submit();
            }
        });

        $("#btn-save-add").click(function () {
            $("#btn-save").data("backToList", false);
            if (validator.form()) {
                $("#form-add-menu").submit();
            }
        });

        // 获取菜单
        function getMenu(parentId) {
            //var requestData = {};
            //requestData.ParentId = parentId;
            $.ajax({
                    type: "POST",
                    url: "@Url.Action("GetLevelMenus", "Menu", new { area = "Admin" })",
                    dataType: "json",
                    //contentType: "application/json;charset=utf-8",
                    data: "parentId=" + parentId,
                    error: function (request, message, error) {
                        alert("获取菜单列表失败");
                    },
                    success: function (responseData) {
                        data = JSON.parse(responseData);
                        if (data.Status == 1) {
                            if (parentId <= 0) {
                                //一级菜单
                                var $firstParentId = $("#firstParentMenuId");
                                $firstParentId.html("");
                                var selectOption = '<option value="0">作为一级菜单</option>';
                                $.each(data.Rows, function (index, item,  value) {
                                    selectOption += '<option value="' + item.Id + '">' + item.MenuName + '</option>';
                                });
                                $firstParentId.append(selectOption);
                            } else {
                                //二级菜单
                                var $secondParentId = $("#secondParentMenuId");
                                $secondParentId.html("");
                                var selectOption = '<option value="0">作为二级菜单</option>';
                                $.each(data.Rows, function (index, item, value) {
                                    selectOption += '<option value="' + item.Id + '">' + item.MenuName + '</option>';
                                });
                                $secondParentId.append(selectOption);
                            }
                        }

                    }
                });
        }
        //一级菜单选择
        $("#firstParentMenuId").change(function () {
            var selectValue = $(this).val();
            if (selectValue <= 0) {
                return;
            } else {
                $("#secondParentMenuId").addClass("show");
                getMenu(selectValue);
            }
        });

        $(function () {
            //初始化一级菜单
            getMenu(0);
        });

    </script>
}
<!-- Scripts -->
<!-- Content Header (Page header) -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <a id="btn-menu-list" href="@Url.Action("Index","Menu",new { area = "Admin" })" class="btn btn-info btn-primary">
                    <i class="fas fa-angle-left"></i>
                    返回菜单列表
                </a>
            </div><!-- /.col -->
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="@Url.Action("Add","Menu",new { area="Admin"})">新增菜单</a></li>
                    <li class="breadcrumb-item active">账号权限</li>
                    <li class="breadcrumb-item active">设置</li>
                </ol>
            </div><!-- /.col -->
        </div><!-- /.row -->
    </div><!-- /.container-fluid -->
</div>
<!-- /.content-header -->
<!-- Main content -->
<section class="content">
    <div class="row">
        <div class="col-12">
            <div class="card card-green">
                <div class="card-header link" data-card-widget="collapse">
                    <h3 class="card-title">新增菜单</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse" data-toggle="tooltip" title="Collapse">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <form id="form-add-menu">
                        <div class="form-row ">
                            <div class="form-group col-6">
                                <label for="menuName" class=" col-form-label">菜单名称</label>
                                <input type="text" class="form-control" id="menuName" name="menuName" placeholder="菜单名称">
                            </div>
                            <div class="form-group  col-6">
                                <label for="menuSystermName" class="col-form-label">菜单系统名称</label>
                                <input type="text" class="form-control" id="menuSystermName" name="menuSystermName" placeholder="菜单系统名称">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-6">
                                <label for="firstParentMenuId">一级菜单</label>
                                <select id="firstParentMenuId" name="firstParentMenuId" class="form-control"></select>
                            </div>
                            <div class="form-group col-6 hidden">
                                <label for="secondParentMenuId">二级菜单</label>
                                <select id="secondParentMenuId" name="secondParentMenuId" class="form-control"></select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group col-6">
                                <label for="menuIcon" class=" col-form-label ">菜单图标</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="menuIcon" name="menuIcon" placeholder="菜单图标">
                                    <div class="input-group-append">
                                        <button class="btn btn-outline-info" type="button" id="button-addon2">选择图标</button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group  col-6">
                                <label for="menuSort" class="col-form-label">排序</label>
                                <input type="text" class="form-control" id="menuSort" name="menuSort" placeholder="0">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="menuUrl" class="col-form-label">菜单地址</label>
                            <input type="text" class="form-control" id="menuUrl" name="menuUrl" placeholder="菜单地址">
                        </div>
                        <div class="form-group">
                            <label for="menuRemark" class=" col-form-label">菜单说明</label>
                            <textarea class="form-control" id="menuRemark" name="menuRemark" placeholder="菜单说明"></textarea>
                        </div>

                        <div class="row justify-content-center ">
                            <input type="button" id="btn-save" value="保存" class="btn btn-success mr-5 " style="width:8rem;">
                            <input type="button" id="btn-save-add" value="保存/添加" class="btn btn-success" style="width:8rem;">
                        </div>
                    </form>

                </div>
                <!-- /.card-body -->
            </div>
            <!-- /.card -->
        </div>
    </div>
</section>
<!-- /.content -->